# Check integration state

- name: Check {{ item.key }} integration state
  win_command: "\"{{ datadog_agent_binary_path }}\" integration show -q {{ item.key }}"
  register: integration_version 
  failed_when: false # This task is supposed to fail when the integration is not installed
  changed_when: false
  
# Remove integration

- name: Removing {{ item.key }} integration 
  win_command: "\"{{ datadog_agent_binary_path }}\" integration remove {{ item.key }}"
  become: yes
  become_user: "{{ integration_command_user }}"
  when: 
    - item.value.action == "remove"
    - integration_version.stdout != ""

# Install integration

- name: Installing pinned version of {{ item.key }} integration 
  win_command: "\"{{ datadog_agent_binary_path }}\" integration install {{ third_party }} {{ item.key }}=={{ item.value.version }}"
  become: yes
  vars:
    third_party: "{% if 'third_party' in item.value and item.value.third_party | bool %}--third-party{% endif %}"
  become_user: "{{ integration_command_user }}"
  when: 
    - item.value.action == "install"
    - integration_version.stdout | trim != item.value.version