---
- name: Remove "all" tracers if installed
  dnf:
    name: datadog-apm-inject-all
    state: absent
  when: not ansible_check_mode and ansible_pkg_mgr == "dnf"

- name: Remove "all" tracers if installed
  yum:
    name: datadog-apm-inject-all
    state: absent
  when: not ansible_check_mode and ansible_pkg_mgr == "yum"

- name: Override "all" to explicitly specify each tracer
  set_fact:
    datadog_apm_instrumentation_languages: ["java", "node", "dotnet", "python", "ruby"]
  when: datadog_apm_instrumentation_languages == ["all"] or
    datadog_apm_instrumentation_lib_versions == ["all"]

- name: Set APM injection languages and versions for RedHat
  set fact:
    agent_dd_apm_install_pkgs: "{{ (agent_dd_apm_install_pkgs |
      default([], true)) + ['datadog-apm-library-' + (item | regex_replace('[:]', '-'))] }}"
    package_state: present
  loop: "{{ datadog_apm_instrumentation_lib_versions }}"
  when: datadog_apm_instrumentation_lib_versions and
    datadog_apm_instrumentation_lib_versions != ["all"]

- name: Set APM injection install packages
  set_fact:
    agent_dd_apm_install_pkgs: "{{ (agent_dd_apm_install_pkgs | default([], true)) +
      ['datadog-apm-library-' + item] }}"
    package_state: latest
  with_items: "{{ datadog_apm_instrumentation_languages }}"
  when: not datadog_apm_instrumentation_lib_versions or
    datadog_apm_instrumentation_lib_versions == ["all"]

- name: Install APM inject libraries (dnf)
  dnf:
    name: "{{ ['datadog-apm-inject'] + (agent_dd_apm_install_pkgs | default([], true)) }}"
    update_cache: true
    state: "{{ (package_state | default('latest')) }}"
  when: not ansible_check_mode and ansible_pkg_mgr == "dnf"

- name: Install APM inject libraries (yum)
  yum:
    name: "{{ ['datadog-apm-inject'] + (agent_dd_apm_install_pkgs | default([], true)) }}"
    update_cache: true
    state: "{{ (package_state | default('latest')) }}"
  when: not ansible_check_mode and ansible_pkg_mgr == "yum"

- name: Show tracers to install
  debug:
    msg: "Installed tracers: {{ agent_dd_apm_install_pkgs }}"
