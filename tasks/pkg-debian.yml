---
- name: Install apt-transport-https
  apt: name=apt-transport-https state=present

- name: Ensure Datadog apt-keys are installed
  apt_key:
    id: "{{ item }}"
    keyserver: "{{ datadog_apt_key_url }}"
    state: present
  with_items:
    # New key
    - A2923DFF56EDA6E76E55E492D3A80E30382E94DE
    # Old key, will be removed in the future
    - C7A7DA52

- name: Ensure Datadog repository is up-to-date
  apt_repository: repo='{{ datadog_apt_repo }}' state=present update_cache=yes

- name: Ensure pinned version of Datadog agent is installed
  apt:
    name: datadog-agent={{ datadog_agent_version }}
    state: present
    force: "{{ datadog_agent_allow_downgrade }}"
  when: datadog_agent_version != ""

- name: Ensure Datadog agent is installed
  apt:
    name: datadog-agent
    state: latest
  when: datadog_agent_version == ""
