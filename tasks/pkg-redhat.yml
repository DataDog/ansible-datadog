---
- name: Download new RPM key
  get_url:
    url: "{{ datadog_yum_gpgkey_e09422b3 }}"
    dest: /tmp/DATADOG_RPM_KEY_E09422B3.public
    checksum: "sha256:{{ datadog_yum_gpgkey_e09422b3_sha256sum }}"

- name: Import new RPM key
  rpm_key:
    key: /tmp/DATADOG_RPM_KEY_E09422B3.public
    state: present
  when: not ansible_check_mode

- name: (Agent 7) Install Datadog yum repo
  yum_repository:
    name: datadog_7
    description: Datadog, Inc.
    baseurl: "https://yum.datadoghq.com/stable/7/{{ ansible_userspace_architecture }}"
    enabled: yes
    gpgcheck: yes
    gpgkey: "{{ datadog_yum_gpgkey_e09422b3 }}"
    state: present
  when: (datadog_yum_repo | length == 0) and (datadog_agent_major_version == 7) and (not ansible_check_mode)

- name: (Agent 6) Install Datadog yum repo
  yum_repository:
    name: datadog_6
    description: Datadog, Inc.
    baseurl: "https://yum.datadoghq.com/stable/6/{{ ansible_userspace_architecture }}"
    enabled: yes
    gpgcheck: yes
    gpgkey: "{{ datadog_yum_gpgkey }}"
    state: present
  when: (datadog_yum_repo | length == 0) and (datadog_agent_major_version == 6) and (not ansible_check_mode)

- name: (Agent 5) Install Datadog yum repo
  yum_repository:
    name: datadog_5
    description: Datadog, Inc.
    baseurl: "https://yum.datadoghq.com/rpm/{{ ansible_userspace_architecture }}"
    enabled: yes
    gpgcheck: yes
    gpgkey: "{{ datadog_yum_gpgkey }}"
    state: present
  when: (datadog_yum_repo | length == 0) and (datadog_agent_major_version == 5) and (not ansible_check_mode)

- name: (Custom) Install Datadog yum repo
  yum_repository:
    name: datadog_custom
    description: Datadog, Inc.
    baseurl: "{{ datadog_yum_repo }}"
    enabled: yes
    gpgcheck: yes
    gpgkey: "{{ datadog_yum_gpgkey }}"
    state: present
  when: (datadog_yum_repo | length > 0) and (not ansible_check_mode)

- name: Install pinned datadog-agent package
  yum:
    name: "datadog-agent-{{ datadog_agent_version }}"
    state: present
    allow_downgrade: "{{ datadog_agent_allow_downgrade }}"
  when: (datadog_agent_version | length != 0) and (not ansible_check_mode)
  notify: restart datadog-agent

- name: Install latest datadog-agent package
  yum:
    name: datadog-agent
    update_cache: yes
    state: latest  # noqa 403
  when: (datadog_agent_version | length == 0) and (not ansible_check_mode)
