---
- name: Fail if OS is not supported
  fail:
    msg: "The Datadog Ansible role does not support your OS yet. Please email support@datadoghq.com to open a feature request."
  when: ansible_facts.os_family not in ["RedHat", "Rocky", "AlmaLinux", "Debian", "Suse", "Windows", "Darwin"]

- name: Upper bound last supported Agent version for Centos < 7
  when: ansible_facts.os_family == "RedHat"
  block:
    - name: Get RHEL major version equivalent
      command: "rpm -E %{rhel}"  # noqa: command-instead-of-module
      register: rhel_version
      changed_when: false
      check_mode: false
    - name: Set upper agent version bound as ansible fact
      set_fact:
        datadog_agent_max_version:
          minor: 51
      when: rhel_version.stdout | int < 7
