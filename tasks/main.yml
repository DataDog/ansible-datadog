---
- name: Gather Ansible Facts
  ansible.builtin.setup:
    gather_subset: "{{ datadog_ansible_facts_subset }}"
    # If the full prefix isn't specified in Ansible 2.10+, we might end up running `ansible.windows.setup` instead.
  when:
    - ansible_facts is undefined
    - ansible_facts.system is undefined

- name: Initialize internal datadog_config variable
  ansible.builtin.set_fact:
    agent_datadog_config: "{{ datadog_config }}"

- name: Check if OS is supported
  ansible.builtin.include_tasks: os-check.yml

- name: Fail if API key is missing
  ansible.builtin.fail:
    msg: "datadog_api_key is mandatory when using managed config"
  when: datadog_api_key is not defined and datadog_manage_config

- name: Resolve datadog_tracked_checks later to defend against variable presidence issues arising from dynamically included null datadog_checks
  ansible.builtin.include_tasks: sanitize-checks.yml

# Also sets agent_datadog_skip_install
- name: Set Facts for Datadog Agent Major Version
  ansible.builtin.include_tasks: set-parse-version.yml

- name: Remove /opt/datadog-agent/python-scripts/__pycache__
  ansible.builtin.file:
    path: /opt/datadog-agent/python-scripts/__pycache__
    state: absent
  when: not agent_datadog_skip_install and ansible_facts.os_family != "Windows" and ansible_facts.os_family != "Darwin"
  failed_when: false
  changed_when: false

- name: Remove legacy package-based datadog-installer
  ansible.builtin.include_tasks: remove-legacy-installer.yml
  when:
    - ansible_facts.os_family != "Windows"
    - ansible_facts.os_family != "Darwin"
    - not ansible_check_mode

- name: Debian Install Tasks
  ansible.builtin.include_tasks: pkg-debian.yml
  when: ansible_facts.os_family == "Debian"

- name: Include tasks to remove old GPG keys
  ansible.builtin.include_tasks: _remove_rpm_keys.yml
  when: ansible_facts.os_family in ["RedHat", "Rocky", "AlmaLinux", "Suse"]
  loop: "{{ datadog_rpm_remove_keys }}"

- name: Include tasks to check removed configuration value usage
  ansible.builtin.include_tasks: check-removed-config.yml

# Only Ansible >= 3.0 knows that AlmaLinux belongs to "RedHat" family
# (and latest bugfix releases of some 2.X)
# For Rocky it is some 4.X and >= 5.0
- name: RedHat Install Tasks
  ansible.builtin.include_tasks: pkg-redhat.yml
  when: ansible_facts.os_family in ["RedHat", "Rocky", "AlmaLinux"]

- name: Suse Install Tasks
  ansible.builtin.include_tasks: pkg-suse.yml
  when: ansible_facts.os_family == "Suse"

# Note we don't check agent_datadog_skip_install variable value for windows here,
# because some tasks in pkg-windows.yml are carried out regardless of its value.
- name: Windows Install Tasks
  ansible.builtin.include_tasks: pkg-windows.yml
  when: ansible_facts.os_family == "Windows"

- name: MacOS Install Tasks
  ansible.builtin.include_tasks: pkg-macos.yml
  when: ansible_facts.os_family == "Darwin" and not agent_datadog_skip_install

- name: Linux Configuration Tasks
  ansible.builtin.include_tasks: agent-linux.yml
  when: ansible_facts.os_family != "Windows" and ansible_facts.os_family != "Darwin"

- name: Windows Configuration Tasks
  ansible.builtin.include_tasks: agent-win.yml
  when: ansible_facts.os_family == "Windows"

- name: MacOS Configuration Tasks
  ansible.builtin.include_tasks: agent-macos.yml
  when: ansible_facts.os_family == "Darwin"

- name: Integrations Tasks
  ansible.builtin.include_tasks: integration.yml
  when: datadog_integration is defined

# Determine if APM Single Step Instrumentation should be installed
- name: Determine and validate APM Single Step Instrumentation configuration
  ansible.builtin.set_fact:
    apm_single_step_instrumentation_should_install: >-
      {{
        datadog_apm_instrumentation_enabled is defined
        and datadog_apm_instrumentation_enabled in ["host", "docker", "all"]
      }}

- name: Fail explicitly if APM Single Step Instrumentation is desired but misconfigured
  ansible.builtin.fail:
    msg: "datadog_apm_instrumentation_enabled must be set to 'host', 'docker', or 'all' when enabling APM Single Step Instrumentation"
  when:
    - datadog_apm_instrumentation_enabled is defined
    - datadog_apm_instrumentation_enabled not in ["host", "docker", "all"]

- name: APM Single Step Instrumentation Install Tasks
  ansible.builtin.include_tasks: apm-single-step-instrumentation.yml
  when:
    - apm_single_step_instrumentation_should_install
    - not ansible_check_mode
